{% extends "users/base.html" %}
{% load humanize %}

{% block title %}{{ business.name }} - The Blue List{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="space-y-6">
        <!-- Basic Information -->
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">{{ business.name }}</h1>
                    {% if business.website %}
                        <a href="{{ business.website }}" target="_blank" rel="noopener noreferrer" 
                           class="text-blue-600 hover:text-blue-800 text-sm">
                            {{ business.website }}
                        </a>
                    {% endif %}
                </div>
                <a href="{% url 'submit_update' business.id %}" 
                   class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm 
                          font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 
                          focus:ring-offset-2 focus:ring-blue-500">
                    Submit Update
                </a>
            </div>
            
            <div class="mt-4 prose max-w-none">
                <p>{{ business.description }}</p>
            </div>
        </div>

        <!-- Company Relationships -->
        {% if business.parent_company or business.subsidiaries.exists %}
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Company Relationships</h2>
            
            {% if business.parent_company %}
            <div class="mb-4">
                <h3 class="text-lg font-medium text-gray-900">Parent Company</h3>
                <a href="{% url 'business_detail' business.parent_company.slug %}" 
                   class="text-blue-600 hover:text-blue-800">
                    {{ business.parent_company.name }}
                </a>
            </div>
            {% endif %}
            
            {% if business.subsidiaries.exists %}
            <div>
                <h3 class="text-lg font-medium text-gray-900">Subsidiaries</h3>
                <ul class="list-disc pl-5 mt-2">
                    {% for subsidiary in business.subsidiaries.all %}
                        <li>
                            <a href="{% url 'business_detail' subsidiary.slug %}" 
                               class="text-blue-600 hover:text-blue-800">
                                {{ subsidiary.name }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 my-4">
            <div class="flex flex-col">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <!-- Info icon -->
                        <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" 
                                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" 
                                  clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            <span class="font-medium">Important Note on Political Donations:</span>
                            Businesses and Organizations can contribute to Political Action Committees, but cannot contribute directly to candidates or party committees. 
                            Figures displayed represent combined contributions from the business/organization, its affiliates and subsidiaries, and its employees.
                        </p>
                    </div>
                </div>
                
                <!-- Expandable Section -->
                <div class="mt-4 ml-8">
                    <button onclick="toggleDataInfo()" class="text-sm text-blue-600 hover:text-blue-800 flex items-center focus:outline-none">
                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path id="infoArrow" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M19 9l-7 7-7-7" />
                        </svg>
                        Learn more about our data sources and how to help
                    </button>
                    
                    <div id="dataInfo" class="hidden mt-2 text-sm text-blue-700 bg-blue-50 p-4 rounded-md">
                        <p class="mb-2">
                            The Blue List is fully open source and operates on a wiki model where any user can contribute updates to correct inaccuracies. 
                        </p>
                        <p class="mb-2">
                            All updates are reviewed to include a data citation and are subject to human review by a site admin before publication. 
                        </p>
                        <p>
                            If you see something that is inaccurate, please submit an update so we can provide the best information possible to our users.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            function toggleDataInfo() {
                const dataInfo = document.getElementById('dataInfo');
                const arrow = document.getElementById('infoArrow');
                
                if (dataInfo.classList.contains('hidden')) {
                    dataInfo.classList.remove('hidden');
                    arrow.setAttribute('d', 'M19 15l-7-7-7 7');  // Point up
                } else {
                    dataInfo.classList.add('hidden');
                    arrow.setAttribute('d', 'M19 9l-7 7-7-7');   // Point down
                }
            }
        </script>

        <!-- Political Data -->
        {% if business.politicaldata %}
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Political Donations for Company and Senior Employees</h2>
            
            <div class="grid grid-cols-2 gap-6 mb-6">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold text-red-600">
                        {{ business.politicaldata.conservative_percentage }}%
                    </div>
                    <div class="text-sm text-gray-600">Conservative</div>
                    <div class="mt-2 text-lg font-semibold">
                        ${{ business.politicaldata.conservative_total_donations|floatformat:2|intcomma }}
                    </div>
                </div>
                
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600">
                        {{ business.politicaldata.liberal_percentage }}%
                    </div>
                    <div class="text-sm text-gray-600">Liberal</div>
                    <div class="mt-2 text-lg font-semibold">
                        ${{ business.politicaldata.liberal_total_donations|floatformat:2|intcomma }}
                    </div>
                </div>
            </div>
            
            {% if business.politicaldata.trump_donor or business.politicaldata.america_pac_donor or business.politicaldata.save_america_pac_donor %}
            <div class="border-t pt-4">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Notable Donations</h3>
                <ul class="space-y-2">
                    {% if business.politicaldata.trump_donor %}
                        <li class="flex items-center text-red-600">
                            <span class="mr-2">⚠️</span>
                            Trump Donor
                        </li>
                    {% endif %}
                    {% if business.politicaldata.america_pac_donor %}
                        <li class="flex items-center text-red-600">
                            <span class="mr-2">⚠️</span>
                            America PAC Donor
                        </li>
                    {% endif %}
                    {% if business.politicaldata.save_america_pac_donor %}
                        <li class="flex items-center text-red-600">
                            <span class="mr-2">⚠️</span>
                            Save America PAC Donor
                        </li>
                    {% endif %}
                </ul>
            </div>
            {% endif %}
            
            {% if business.politicaldata.data_source %}
            <div class="border-t pt-4 mt-4">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Data Sources</h3>
                <div class="prose max-w-none">
                    {{ business.politicaldata.data_source|linebreaks }}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Services and Products -->
        {% if business.provides_services or business.provides_products %}
        <div class="bg-white p-6 rounded-lg shadow space-y-6">
            {% if business.provides_services %}
            <div>
                <h2 class="text-xl font-semibold mb-4">Services Provided</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for service in business.services.all %}
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <h3 class="font-medium text-gray-900">{{ service.name }}</h3>
                            {% if service.description %}
                                <p class="text-sm text-gray-600 mt-1">
                                    {{ service.description }}
                                </p>
                            {% endif %}
                        </div>
                    {% empty %}
                        <p class="text-gray-600 italic col-span-2">
                            This business is marked as a service provider but no specific services are listed yet.
                        </p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if business.provides_products %}
            <div>
                <h2 class="text-xl font-semibold mb-4">Products Offered</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for product in business.products.all %}
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <h3 class="font-medium text-gray-900">{{ product.name }}</h3>
                            {% if product.description %}
                                <p class="text-sm text-gray-600 mt-1">
                                    {{ product.description }}
                                </p>
                            {% endif %}
                        </div>
                    {% empty %}
                        <p class="text-gray-600 italic col-span-2">
                            This business is marked as a product provider but no specific products are listed yet.
                        </p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if request.user.is_authenticated %}
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="text-sm text-gray-600">
                        See something incorrect? 
                        <a href="{% url 'submit_update' business.id %}" 
                        class="text-blue-600 hover:text-blue-800">
                            Submit an update
                        </a>
                    </p>
                </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Metadata -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Information History</h2>
            <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                <div>
                    <span class="font-medium">Created:</span> 
                    {{ business.created_at|date:"F j, Y" }}
                </div>
                <div>
                    <span class="font-medium">Last Updated:</span> 
                    {{ business.updated_at|date:"F j, Y" }}
                </div>
            </div>
        </div>

        <!-- Placeholder for future competing businesses section -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Alternative Businesses</h2>
            
            {% if alternatives %}
                <div class="space-y-4">
                    {% for alt in alternatives %}
                        <div class="border-b border-gray-200 pb-4 last:border-b-0">
                            <div class="flex justify-between items-start">
                                <div class="space-y-1">
                                    <div class="flex items-center gap-2">
                                        <h3 class="text-lg font-medium">
                                            <a href="{% url 'business_detail' alt.business.slug %}" 
                                            class="text-blue-600 hover:text-blue-800">
                                                {{ alt.business.name }}
                                            </a>
                                        </h3>
                                    </div>
                                    
                                    <p class="text-sm text-gray-600">
                                        {{ alt.business.description|truncatewords:30 }}
                                    </p>
                                    
                                    <!-- Similarity Info -->
                                    <div class="text-sm text-gray-500">
                                        Matches {{ alt.overlap_count }} product{{ alt.overlap_count|pluralize:",s" }}/service{{ alt.overlap_count|pluralize:",s" }}
                                    </div>

                                    {% if alt.business.politicaldata %}
                                        <div class="mt-2">
                                            <div class="text-sm">
                                                <span class="text-red-600">{{ alt.business.politicaldata.conservative_percentage }}% Conservative</span> / 
                                                <span class="text-blue-600">{{ alt.business.politicaldata.liberal_percentage }}% Liberal</span>
                                                {% if alt.business.politicaldata.conservative_total_donations or alt.business.politicaldata.liberal_total_donations %}
                                                    <br>
                                                    <span class="text-gray-600 text-xs">
                                                        Total Donations: ${{ alt.business.politicaldata.conservative_total_donations|floatformat:2 }} Conservative / 
                                                        ${{ alt.business.politicaldata.liberal_total_donations|floatformat:2 }} Liberal
                                                    </span>
                                                {% endif %}
                                            </div>
                                            {% if alt.business.politicaldata.trump_donor %}
                                                <div class="text-sm text-red-600">⚠️ Trump Donor</div>
                                            {% endif %}
                                            {% if alt.business.politicaldata.america_pac_donor %}
                                                <div class="text-sm text-red-600">⚠️ America PAC Donor</div>
                                            {% endif %}
                                            {% if alt.business.politicaldata.save_america_pac_donor %}
                                                <div class="text-sm text-red-600">⚠️ Save America PAC Donor</div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500">No alternative businesses found with similar offerings.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}